name: Codex PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # AI ÏΩîÎ©òÌä∏Ïóê ÎãµÍ∏Ä Îã¨Î©¥ ÎåÄÌôî Í≥ÑÏÜç
  codex-reply:
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       !contains(github.event.comment.body, '/codex review') &&
       (github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
      ||
      (github.event_name == 'pull_request_review_comment' &&
       (github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Check if reply to AI comment
        id: check_reply
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Check if this is a reply to github-actions bot or mentions @codex
          if echo "$COMMENT_BODY" | grep -qiE "@github-actions|@codex|ÏßàÎ¨∏|Ïôú|Ïñ¥ÎñªÍ≤å|ÏÑ§Î™Ö"; then
            echo "is_ai_reply=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_ai_reply=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        if: steps.check_reply.outputs.is_ai_reply == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Codex CLI
        if: steps.check_reply.outputs.is_ai_reply == 'true'
        run: npm install -g @openai/codex@latest

      - name: Restore Codex OAuth credentials
        if: steps.check_reply.outputs.is_ai_reply == 'true'
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          if [ -z "$CODEX_AUTH_JSON" ]; then
            echo "::error::CODEX_AUTH_JSON secret is not configured"
            exit 1
          fi
          mkdir -p ~/.codex
          printf '%s' "$CODEX_AUTH_JSON" > ~/.codex/auth.json
          chmod 600 ~/.codex/auth.json

      - name: Reply to user
        if: steps.check_reply.outputs.is_ai_reply == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          USER_COMMENT: ${{ github.event.comment.body }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          CODEX_PROMPT="You are an AI code reviewer assistant. A user has asked a follow-up question on a PR review.

          PR: $PR_NUMBER
          User's question: $USER_COMMENT

          Instructions:
          1. Get context: \`gh pr view \"$PR_NUMBER\" --json title,body\`
          2. If needed, check the diff: \`gh pr diff \"$PR_NUMBER\"\`
          3. Provide a helpful, concise response to the user's question
          4. Post your reply: \`gh pr comment \"$PR_NUMBER\" --body \"Your response here\"\`
          5. Keep the response focused and technical

          Respond helpfully to the user's question."

          codex exec \
            -m gpt-5-codex \
            --sandbox danger-full-access \
            -c shell_environment_policy.inherit=all \
            -c ask_for_approval=\"never\" \
            -C "$GITHUB_WORKSPACE" \
            -- "$CODEX_PROMPT"

      - name: Cleanup credentials
        if: always()
        run: rm -f ~/.codex/auth.json

  codex-review:
    if: |
      (github.event_name == 'pull_request' && (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'develop')) ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/codex review') &&
       (github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.pull_request.number || github.event.issue.number }}/head

      - name: Set review context
        id: review_context
        env:
          REPO: ${{ github.repository }}
        run: |
          PR_NUMBER=$(jq -r '.pull_request.number // .issue.number' "$GITHUB_EVENT_PATH")
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "Unable to determine PR number from event payload" >&2
            exit 1
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Install Codex CLI
        run: |
          npm install -g @openai/codex@latest

      - name: Restore Codex OAuth credentials
        env:
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON }}
        run: |
          if [ -z "$CODEX_AUTH_JSON" ]; then
            echo "::error::CODEX_AUTH_JSON secret is not configured"
            exit 1
          fi

          mkdir -p ~/.codex
          printf '%s' "$CODEX_AUTH_JSON" > ~/.codex/auth.json
          chmod 600 ~/.codex/auth.json

      - name: Setup MCP servers
        run: |
          cat >> ~/.codex/config.toml << 'EOF'

          # Context7 - Library documentation (LangChain, FastAPI, Pydantic, etc.)
          [mcp_servers.context7]
          command = "npx"
          args = ["-y", "@upstash/context7-mcp"]
          EOF

          echo "‚úÖ MCP servers configured (context7)"

      - name: Run Codex review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.review_context.outputs.pr_number }}
          REPO: ${{ github.repository }}
          CODEX_PROMPT: |
            You are a senior AI/ML engineer performing a thorough code review for a LangChain/LangGraph RAG application.

            <context>
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.review_context.outputs.pr_number }}

            PROJECT STRUCTURE:
            - poc/src/adapters: External service adapters (OpenAI, embeddings)
            - poc/src/api: FastAPI endpoints
            - poc/src/memory: Conversation memory implementations
            - poc/src/schemas: Pydantic models
            - poc/src/services: Business logic
            - poc/src/supervisor: LangGraph supervisor/orchestrator
            - poc/src/workers: LangGraph worker nodes

            AVAILABLE MCP TOOLS:
            - context7: Use to look up LangChain, LangGraph, FastAPI, Pydantic documentation

            When reviewing LangChain/LangGraph code, use context7 to verify correct API usage.
            For GitHub operations, use the `gh` CLI which is already available.
            </context>

            <project_rules>
            This is a LangChain/LangGraph RAG (Retrieval-Augmented Generation) project.

            ## Architecture Rules
            - LangGraph state must be immutable (return new state, don't mutate)
            - Worker nodes should be single-responsibility
            - Use supervisor pattern for orchestration
            - Adapters wrap external services (OpenAI, vector stores)

            ## Coding Standards (CRITICAL)
            - [ ] **NO LAZY IMPORTS**: All imports MUST be at file top level. Imports inside functions are FORBIDDEN.
            - [ ] **TYPE HINTS**: All functions must have type hints.
            - [ ] **ASYNC/AWAIT**: LangChain async methods (ainvoke, astream) must be awaited properly.
            - [ ] **PYDANTIC V2**: Use Pydantic v2 syntax (model_validate, model_dump).
            - [ ] **NO PRINT**: Use loguru logger, not print().

            ## LangChain/LangGraph Rules
            - Use RunnablePassthrough, RunnableLambda for chain composition
            - Avoid deprecated LangChain APIs (check for deprecation warnings)
            - LangGraph nodes must return valid state updates
            - Use structured output (with_structured_output) for reliable parsing
            - Handle token limits and chunking properly

            ## Security
            - Never log API keys, tokens, or sensitive data
            - Validate user inputs before passing to LLM
            - Sanitize outputs before returning to client
            </project_rules>

            <review_checklist>
            ### 1. LangChain/LangGraph
            - [ ] No deprecated APIs used
            - [ ] Proper async/await for ainvoke, astream
            - [ ] State management is immutable
            - [ ] Chains are composable and testable

            ### 2. Code Quality
            - [ ] Type hints on all functions
            - [ ] No lazy imports
            - [ ] Pydantic v2 syntax
            - [ ] Proper error handling

            ### 3. Security
            - [ ] No hardcoded secrets
            - [ ] Input validation present
            - [ ] No sensitive data in logs

            ### 4. Testing (CRITICAL)
            - [ ] New/modified code has corresponding test files
            - [ ] Tests cover happy path and edge cases
            - [ ] If no tests added, flag as MUST FIX

            ### 5. Side Effects & Bug Prevention (CRITICAL)
            - [ ] Check for logic conflicts with existing code
            - [ ] Identify potential race conditions in async code
            - [ ] Verify state mutations don't cause unintended side effects
            - [ ] Check for breaking changes to public APIs
            - [ ] Ensure error handling doesn't silently swallow exceptions
            - [ ] Verify edge cases are handled (null, empty, boundary values)
            </review_checklist>

            <inline_suggestions>
            For fixable issues, post inline suggestion comments using gh api.

            CORRECT API FORMAT:
            ```bash
            COMMIT_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid -q '.headRefOid')

            gh api "repos/$REPO/pulls/$PR_NUMBER/comments" \
              --method POST \
              -f body=$'```suggestion\ncorrected code here\n```\nExplanation' \
              -f commit_id="$COMMIT_SHA" \
              -f path="path/to/file.py" \
              -F line:=42 \
              -f side="RIGHT"
            ```

            CRITICAL RULES:
            - line must be integer: YOU MUST USE UPPERCASE `-F` with `:=` like: `-F line:=42`
            - DO NOT use `-f` for the line argument (it creates an invalid `line:` key)
            - commit_id: get from `gh pr view --json headRefOid`
            - side: "RIGHT" for new code, "LEFT" for old code
            - path: relative path from repo root

            Post inline suggestions for each fixable issue found.
            </inline_suggestions>

            <output_format>
            Write your review as a PR comment in this EXACT format:

            ## üîç Code Review Summary
            (Brief overview of changes and overall assessment)

            ## ‚úÖ What's Good
            (Well-written parts, good practices observed)

            ## üö® Issues Found
            (List any violations. Include file path and line numbers.)

            Format: `file_path:line` - Description

            ## üí° Inline Suggestions
            (Note: I've added inline suggestions on specific lines that can be applied with one click)

            ## üìã Checklist
            - LangChain/LangGraph: ‚úÖ/‚ùå
            - Type Hints: ‚úÖ/‚ùå
            - Security: ‚úÖ/‚ùå
            - Tests: ‚úÖ/‚ùå
            - Side Effects/Bugs: ‚úÖ/‚ùå
            </output_format>

            <instructions>
            1. Get PR info:
               - `gh pr diff "$PR_NUMBER"` for changes
               - `gh pr view "$PR_NUMBER" --json title,body,headRefOid` for metadata

            2. Review code against <project_rules>

            3. For fixable issues, post inline suggestions:
               ```bash
               COMMIT_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid -q '.headRefOid')
               gh api "repos/$REPO/pulls/$PR_NUMBER/comments" \
                 --method POST \
                 -f body=$'```suggestion\nfixed code\n```\nExplanation' \
                 -f commit_id="$COMMIT_SHA" \
                 -f path="file.py" \
                 -F line:=42 \
                 -f side="RIGHT"
               ```

            4. Post summary review comment:
               `gh pr comment "$PR_NUMBER" --body-file review.md`

            5. Determine approval decision:
               - If ALL checklist items are ‚úÖ (no ‚ùå): Write "APPROVED" to decision.txt
               - If ANY checklist item is ‚ùå: Write "CHANGES_REQUESTED" to decision.txt

            6. Execute approval/rejection:
               - If APPROVED:
                 1. First, dismiss any previous CHANGES_REQUESTED reviews from github-actions:
                    ```bash
                    # Get review IDs with CHANGES_REQUESTED state and dismiss them
                    gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" --jq '.[] | select(.state == "CHANGES_REQUESTED" and .user.login == "github-actions[bot]") | .id' | while read review_id; do
                      gh api "repos/$REPO/pulls/$PR_NUMBER/reviews/$review_id/dismissals" -f message="Superseded by passing review" -f event="DISMISS"
                    done
                    ```
                 2. Then approve: `gh pr review "$PR_NUMBER" --approve --body "‚úÖ AI Review Passed - All checks passed"`
               - If CHANGES_REQUESTED: `gh pr review "$PR_NUMBER" --request-changes --body "‚ùå AI Review Failed - Please fix the issues above"`

            7. Exit after completing review
            </instructions>

            Now review this PR, post your review comment, and approve or request changes based on the checklist results.
        run: |
          codex exec \
            -m gpt-5-codex \
            --sandbox danger-full-access \
            -c shell_environment_policy.inherit=all \
            -c ask_for_approval=\"never\" \
            -C "$GITHUB_WORKSPACE" \
            -- "$CODEX_PROMPT"

      - name: Cleanup credentials
        if: always()
        run: rm -f ~/.codex/auth.json ~/.codex/config.toml
